name: Build & Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  build:
    name: Build ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          # Linux
          - { runner: ubuntu-latest, os: linux, arch: amd64, flags: "" }
          - { runner: ubuntu-latest, os: linux, arch: arm64, flags: "" }
          - { runner: ubuntu-latest, os: linux, arch: armv7, flags: "-e GOARM=7" }
          # macOS
          - { runner: macos-latest, os: darwin, arch: amd64, flags: "" }
          - { runner: macos-latest, os: darwin, arch: arm64, flags: "" }
          # Windows
          - { runner: windows-latest, os: windows, arch: amd64, flags: "" }
          - { runner: windows-latest, os: windows, arch: arm64, flags: "" }
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - uses: actions/setup-go@v4
        with:
          go-version: '1.25.1'
          cache: true
      
      - name: Build ${{ matrix.os }}-${{ matrix.arch }}
        run: |
          mkdir -p dist
          VERSION=${{ github.ref_name }}
          BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')
          OUTPUT=go-platform-${VERSION}-${{ matrix.os }}-${{ matrix.arch }}
          
          if [ "${{ matrix.os }}" = "windows" ]; then
            OUTPUT="${OUTPUT}.exe"
          fi
          
          env CGO_ENABLED=0 GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} ${{ matrix.flags }} \
          go build \
            -ldflags "-X main.Version=${VERSION} -X main.BuildTime=${BUILD_TIME}" \
            -o dist/${OUTPUT}
          
          # Create checksums
          if command -v sha256sum &> /dev/null; then
            sha256sum dist/${OUTPUT} > dist/${OUTPUT}.sha256
          else
            shasum -a 256 dist/${OUTPUT} > dist/${OUTPUT}.sha256
          fi
        shell: bash
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/
          retention-days: 7
  
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Flatten artifacts
        run: |
          mkdir -p release
          find artifacts -type f -exec cp {} release/ \;
          ls -la release/
      
      - name: Create checksums file
        working-directory: release
        run: |
          cat *.sha256 > CHECKSUMS
          cat CHECKSUMS
      
      - name: Create Release Notes
        id: release_notes
        run: |
          VERSION=${{ github.ref_name }}
          echo "## Changelog" > /tmp/release-notes.md
          echo "" >> /tmp/release-notes.md
          git log --oneline $(git describe --tags --abbrev=0 HEAD^)..HEAD >> /tmp/release-notes.md || echo "Initial release" >> /tmp/release-notes.md
          cat /tmp/release-notes.md
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          body_path: /tmp/release-notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
